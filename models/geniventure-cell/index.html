<html>
  <head>
    <script type="text/javascript" src="../../organelle.js" charset="utf-8"></script>
    <style media="screen" type="text/css">
      .model {
        position: absolute;
        left: 0;
        top: 0;
        height: 100vh;
        width: 160vh;
        opacity: 1;
        -webkit-transition: opacity 5s;
        transition: opacity 5s;
      }

      .hidden-iframe {
        width: 0;
        height: 0;
        opacity: 0;
      }

      .temp-iframe {
        opacity: 0;
      }

      iframe {
        position: absolute;
        width: 100%;
        height: 100%;
        border: none;
      }

      #close-protein-game {
        position: absolute;
        bottom: 2vh;
        left: 140vh;
      }
    </style>
  </head>
  <body>
    <svg id="model" viewBox="0 0 1280 800" class="model"></svg>
    <div id="protein-game-wrapper" class="model hidden-iframe">
      <iframe id="protein-game"></iframe>
      <button id="close-protein-game">Zoom back to cell</button>
    </div>

    <script>
      window.model = Organelle.createModel({
        element: "model",
        background: {
          file: "assets/melanocyte.svg",
          selector: "#cell"
        },
        properties: {
          working_tyr1: true,
          working_myosin_5a: true
        },
        species: [
          {
            name: "melanosome",
            image: "assets/melanosome.svg",
            selector: "#melanosome",
            spawn: {
              on: {
                selector: "#golgi_x5F_apparatus path",
                at: "random"
              },
              every: 90
            },
            rules: {
              initialization: [
                {
                  set: {
                    size: 0.1,
                    speed: 1
                  },
                  switch_state: "growing"
                }
              ],
              growing: [
                {
                  if: {
                    fact: "world.working_tyr1"
                  },
                  then: [
                    {
                      grow: {
                        by: 0.005,
                        until: 1,
                        finally: {
                          switch_state: "seeking_microtuble"
                        }
                      }
                    },
                    {
                      if: {
                        fact: "size",
                        between: [0.5, 0.7]
                      },
                      then: {
                        set_attr: {
                          selector: "#Layer1_0_FILL",
                          set: {
                            fill: "url(#_Radial2)"
                          }
                        }
                      }
                    },
                    {
                      if: {
                        fact: "size",
                        between: [0.7, 0.9]
                      },
                      then: {
                        set_attr: {
                          selector: "#Layer1_0_FILL",
                          set: {
                            fill: "url(#_Radial3)"
                          }
                        }
                      }
                    },
                    {
                      if: {
                        fact: "size",
                        greaterThan: 0.9
                      },
                      then: {
                        set_attr: {
                          selector: "#Layer1_0_FILL",
                          set: {
                            fill: "url(#_Radial4)"
                          }
                        }
                      }
                    }
                  ],
                  else: {
                    grow: {
                      by: 0.005,
                      until: 0.6,
                      finally: {
                        set_attr: {
                          selector: "#Layer1_0_FILL",
                          set: {
                            fill: "url(#_Radial2)"
                          }
                        },
                        switch_state: "seeking_microtuble"
                      }
                    }
                  }
                }
              ],
              seeking_microtuble: [
                {
                  move_to: {
                    selector: "#microtubules_x5F_grouped path",
                    which: "random",
                    finally: {
                      switch_state: "following_microtuble_outwards"
                    }
                    // x: 0,
                    // y: 0
                  }
                  // change: {
                  //   prop: "x",
                  //   by: 0.5
                  // }
                }
              ],
              following_microtuble_outwards: [
                {
                  if: {
                    fact: "world.working_myosin_5a"
                  },
                  then: {
                    follow: {
                      selector: "#microtubules_x5F_grouped path",
                      which: "nearest",
                      direction: "forward",
                      until: [0.2, 0.9],
                      finally: {
                        // switch_state: "waiting_at_edge_of_cell"
                        switch_state: "find_actin_terminal"
                      }
                    }
                  },
                  else: {
                    follow: {
                      selector: "#microtubules_x5F_grouped path",
                      which: "nearest",
                      direction: "forward",
                      finally: {
                        switch_state: "waiting_at_edge_of_cell"
                        // switch_state: "find_actin_terminal"
                      }
                    }
                  }
                }
              ],
              waiting_at_edge_of_cell: [
                {
                  wait: {
                    for: [0, 200],
                    finally: {
                      switch_state: "following_microtuble_inwards"
                    }
                  }
                }
              ],
              following_microtuble_inwards: [
                {
                  follow: {
                    selector: "#microtubules_x5F_grouped path",
                    which: "nearest",
                    at: 1,
                    direction: "backward",
                    finally: {
                      switch_state: "find_nuclear_actin_terminal"
                    }
                  }
                }
              ],
              find_actin_terminal: [
                {
                  move_to: {
                    selector: "#actin_terminals circle",
                    which: {
                      any_of_nearest: 6
                    },
                    finally: {
                      switch_state: "waiting_on_actin_terminal"
                    }
                  }
                }
              ],
              find_nuclear_actin_terminal: [
                {
                  move_to: {
                    selector: "#nuclear_actin_terminals circle",
                    which: {
                      any_of_nearest: 5
                    },
                    finally: {
                      switch_state: "waiting_on_nuclear_actin_terminal"
                    }
                  }
                }
              ],
              waiting_on_actin_terminal: [
                {
                  wait: {
                    for: 3000,
                    finally: {
                      switch_state: "dying"
                    }
                  }
                }
              ],
              waiting_on_nuclear_actin_terminal: [
                {
                  wait: {
                    for: 3000,
                    finally: {
                      switch_state: "dying"
                    }
                  }
                }
              ],
              dying: [
                {
                  grow: {
                    by: -0.02,
                    until: 0,
                    finally: {
                      die: true
                    }
                  }
                }
              ],
              always: [
                {
                  if: {
                    all: [
                      {
                        fact: "world.working_myosin_5a"
                      },
                      {
                        state: "waiting_on_nuclear_actin_terminal"
                      }
                    ]
                  },
                  then: {
                    wait: {
                      for: [100, 700],
                      finally: {
                        switch_state: "dying"
                      }
                    }
                  }
                },
                {
                  if: {
                    all: [
                      {
                        fact: {
                          not: "world.working_myosin_5a"
                        }
                      },
                      {
                        state: "waiting_on_actin_terminal"
                      }
                    ]
                  },
                  then: {
                    wait: {
                      for: [100, 700],
                      finally: {
                        switch_state: "dying"
                      }
                    }
                  }
                }
              ]
            }
          }
        ],
        clickHandlers: [
          {
            selector: "#golgi_x5F_apparatus",
            action: enterProteinGame
          }
        ]
      });

      function addClass(el, className) {
        if (el.classList)
          el.classList.add(className);
        else
          el.className += ' ' + className;
      }

      function removeClass(el, className) {
        if (el.classList)
          el.classList.remove(className);
        else
          el.className = el.className.replace(new RegExp('(^|\\b)' + className.split(' ').join('|') + '(\\b|$)', 'gi'), ' ');
      }


      var iframe = document.getElementById("protein-game"),
          wrapper = document.getElementById("protein-game-wrapper"),
          reverseZoom;

      function enterProteinGame(Snap, el) {
        Snap.animate(el.attr("viewBox").vb.split(" "), [370, 500, 110, 69],
          function (vals) { el.attr("viewBox", vals.join(" ")); }, 1500,
          function() {
            model.stop();
            iframe.src = "http://geniverse2.fablevision-dev.com/protein_game_2/";
            removeClass(wrapper, "hidden-iframe");
          }
        );

        reverseZoom = function() {
          Snap.animate(el.attr("viewBox").vb.split(" "), [0, 0, 1280, 800],
            function (vals) { el.attr("viewBox", vals.join(" ")); }, 1500
          );
        }
      }

      function exitProteinGame() {
        addClass(wrapper, "temp-iframe");
        setTimeout(function() {
          model.run();
          setTimeout(function() {
            iframe.src = "";
            reverseZoom();
            addClass(wrapper, "hidden-iframe");
            removeClass(wrapper, "temp-iframe");
          }, 2000)
        }, 1000)
      }

      document.getElementById("close-protein-game").onclick = exitProteinGame;
    </script>
  </body>
</html>
