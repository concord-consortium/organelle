<html>
  <head>
    <script type="text/javascript" src="../../organelle.js" charset="utf-8"></script>
    <script type="text/javascript" src="lib/iframe-phone.js" charset="utf-8"></script>
    <style media="screen" type="text/css">
      .model {
        position: absolute;
        left: 0;
        top: 0;
        height: 100vh;
        width: 160vh;
        opacity: 1;
        -webkit-transition: opacity 6s;
        transition: opacity 6s;
      }

      .hidden-iframe {
        width: 10;
        height: 10;
        opacity: 0;
      }

      .temp-iframe {
        opacity: 0;
      }

      iframe {
        position: absolute;
        width: 100%;
        height: 100%;
        border: none;
      }

      #world-props {
        position: absolute;
        left: 161vh;
        bottom: 1vh;
      }
    </style>
  </head>
  <body>
    <svg id="model" viewBox="0 0 1280 800" class="model">
    </svg>
    <div id="protein-game-wrapper" class="model hidden-iframe">
      <iframe id="protein-game"></iframe>
    </div>

    <fieldset id="world-props">
      <legend>Cell props</legend>
      <input id="albino" type="checkbox" /><label for="albino">albino</label><br/>
      <input id="working_tyr1" type="checkbox" checked="checked"/><label for="working_tyr1">working_tyr1</label><br/>
      <input id="working_myosin_5a" type="checkbox" checked="checked"/><label for="working_tyr1">working_myosin_5a</label>
      <input id="open_gates" type="checkbox" checked="checked"/><label for="open_gates">open_gates</label>
    </fieldset>

    <script>
      var model,
          initialDrakeColor = "lava",
          finalDrakeColor = "charcoal",
          gameUrl = "https://www.fablevision.com/geniverse_proteins/index.html?allele-shorthand=10111111&initial-state=size&target-color=lava"

      Organelle.createModel({
        element: "model",
        background: {
          file: "assets/melanocyte.svg",
          selector: "#cell"
        },
        properties: {
          albino: false,
          working_tyr1: true,
          working_myosin_5a: true,
          open_gates: true
        },
        calculatedProperties: {
          saturation: {
            ratio: {
              numerator: {
                count: {
                  species: "melanosome",
                  state: [
                    "waiting_on_actin_terminal",
                    "waiting_on_nuclear_actin_terminal"
                  ],
                }
              },
              denominator: 20
            }
          },
          lightness: {
            ratio: {
              numerator: {
                count: {
                  species: "melanosome",
                  state: "waiting_on_nuclear_actin_terminal"
                }
              },
              denominator: 10
            }
          },
          grayness: {
            ratio: {
              numerator: {
                count: {
                  species: "melanosome",
                  state: [
                    "waiting_on_actin_terminal",
                    "waiting_on_nuclear_actin_terminal"
                  ],
                  rules: {
                    fact: "size",
                    greaterThan: 0.7
                  }
                }
              },
              denominator: {
                count: {
                  species: "melanosome",
                  state: ["waiting_on_actin_terminal", "waiting_on_nuclear_actin_terminal"],
                  rules: {
                    fact: "size",
                    lessThan: 0.7
                  }
                }
              }
            }
          }
        },
        species: [
          "organelles/melanosome.yml",
          "organelles/zoomed-melanosome.yml"
        ],
        clickHandlers: [
          {
            selector: "#golgi_x5F_apparatus",
            action: enterProteinGame
          }
        ]
      }).then(function(m) {
        model = m;

        // setTimeout( () => {
          model.stop()
          model.step(1000)
        // // }, 2000)
        model.run()

        var urlParams;
        (window.onpopstate = function () {
            var match,
                pl     = /\+/g,  // Regex for replacing addition symbol with a space
                search = /([^&=]+)=?([^&]*)/g,
                decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
                query  = window.location.search.substring(1)

            urlParams = {}
            while (match = search.exec(query))
               urlParams[decode(match[1])] = decode(match[2])

            let challenge = urlParams.chal
            if (challenge) {
              initialDrakeColor = challenge.split("-")[0]
              finalDrakeColor = challenge.split("-")[1]
              setCellPhenotype(initialDrakeColor)
              setGameUrl(initialDrakeColor, finalDrakeColor)
            }
        })();

        model.addListener( () => {
          let saturation = Math.min(model.world.getProperty("saturation"), 1) || 0,
              lightness = Math.min(model.world.getProperty("lightness"), 1),
              grayness = Math.min(model.world.getProperty("grayness"), 1)

          if (isNaN(lightness)) {
            lightness = 0
          }
          if (isNaN(grayness)) {
            grayness = 1
          }

          let gray = [123,116,110],
              orange = [200, 147, 107],
              color = gray.map( (g, i) => Math.floor(((g * grayness) + (orange[i] * (1-grayness))) + lightness * 30) ),
              colorStr = "rgb("+color.join()+")"

          if (document.getElementById("cellshape_0_Layer0_0_FILL")) {
            document.getElementById("cellshape_0_Layer0_0_FILL").style["fill-opacity"] = saturation
            document.getElementById("cellshape_0_Layer0_0_FILL").style["fill"] = colorStr
          }
        })
      });

      function addClass(el, className) {
        if (el.classList)
          el.classList.add(className);
        else
          el.className += ' ' + className;
      }

      function removeClass(el, className) {
        if (el.classList)
          el.classList.remove(className);
        else
          el.className = el.className.replace(new RegExp('(^|\\b)' + className.split(' ').join('|') + '(\\b|$)', 'gi'), ' ');
      }

      var iframe = document.getElementById("protein-game"),
          wrapper = document.getElementById("protein-game-wrapper"),
          entering = false,
          createdAgent,
          reverseZoom;

      function enterProteinGame(Snap, el) {
        if (entering) {
          return
        }
        entering = true

        iframe.src = gameUrl

        let zoomDelay = 1300,
            iframeDelay = initialDrakeColor === "albino" ? 1800 : initialDrakeColor === "lava" ? 2300 : 2800,
            modelStopDelay = 4000
        Snap.animate(el.attr("viewBox").vb.split(" "), [391, 518, 72, 45],
          function (vals) { el.attr("viewBox", vals.join(" ")); }, zoomDelay
        );

        model.setTimeout( () => {
          createdAgent = model.world.createAgent(model.world.species[1])
        }, zoomDelay)
        model.setTimeout( () => {
          var phone = new iframePhone.ParentEndpoint(iframe)
          phone.addListener('activityExit', function (content) {
            setTimeout(exitProteinGame, 1000)
          })
          phone.addListener('activityWin', function (content) {
            setTimeout(exitProteinGame, 1000)
            setCellPhenotype(finalDrakeColor)
          })

          removeClass(wrapper, "hidden-iframe")
        }, iframeDelay)
        model.setTimeout( () => {
          model.stop()
        }, modelStopDelay)

        reverseZoom = function() {
          Snap.animate(el.attr("viewBox").vb.split(" "), [0, 0, 1280, 800],
            function (vals) { el.attr("viewBox", vals.join(" ")); }, 1500
          )
        }
      }


      function exitProteinGame() {
        addClass(wrapper, "temp-iframe");

        createdAgent.setProperty("size", 0.1)
        createdAgent.state = "growing"
        model.step(2000)

        setTimeout(function() {
          iframe.src = ""
          reverseZoom()
          addClass(wrapper, "hidden-iframe")
          removeClass(wrapper, "temp-iframe")

          model.setTimeout(function() {
            createdAgent.species = model.world.species[0]
            entering = false
          }, 600)
          model.run()
        }, 2000)
      }

      function observePropCheckbox(prop) {
        document.getElementById(prop).onclick = function() {
          model.world.setProperty(prop, document.getElementById(prop).checked)
        }
      }
      function setPropCheckbox(prop, value) {
        model.world.setProperty(prop, value)
        document.getElementById(prop).checked = value
      }
      observePropCheckbox("albino");
      observePropCheckbox("working_tyr1");
      observePropCheckbox("working_myosin_5a");
      observePropCheckbox("open_gates");

      function setCellPhenotype(color) {
        if (color === "albino") {
          setPropCheckbox("albino", true)
        } else if (color === "charcoal") {
          setPropCheckbox("albino", false)
          setPropCheckbox("working_tyr1", true)
          setPropCheckbox("working_myosin_5a", true)
        } else if (color === "lava") {
          setPropCheckbox("albino", false)
          setPropCheckbox("working_tyr1", false)
          setPropCheckbox("working_myosin_5a", true)
        } else if (color === "ash") {
          setPropCheckbox("albino", false)
          setPropCheckbox("working_tyr1", true)
          setPropCheckbox("working_myosin_5a", false)
        } else if (color === "sand") {
          setPropCheckbox("albino", false)
          setPropCheckbox("working_tyr1", false)
          setPropCheckbox("working_myosin_5a", false)
        }
      }

      function setGameUrl(initial, final) {
        // charcoal     allele-shorthand=10111111&initial-state=size&target-color=lava
        // lava         allele-shorthand=00111111&initial-state=size&target-color=charcoal
        // albino       allele-shorthand=11001111&initial-state=size&target-color=charcoal
        let alleleShorthand = ""
        if (initial === "albino") {
          alleleShorthand = "11001111"
        } else if (initial === "charcoal") {
          alleleShorthand = "10111111"
        } else if (initial === "lava") {
          alleleShorthand = "00111111"
        }

        gameUrl = "https://www.fablevision.com/geniverse_proteins/index.html?allele-shorthand="+alleleShorthand+"&initial-state=size&target-color="+final
      }

    </script>
  </body>
</html>
