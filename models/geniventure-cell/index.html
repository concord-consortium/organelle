<!--
  Cell URL Parameters:

  ?chal=charcoal-lava&alleles=10111111&game=size&missionId=3.2.3&video=charcoal&skip=true

  chal=charoal-lava
    initial and goal colors. Sets `initialDrakeColor` and `finalDrakeColor`
    Sets `alleleShorthand` in FV_URL if `alleles` not set
    Sets `target-color` in FV_URL
  alleles=10111111
    Sets `alleleShorthand` in FV_URL
  game=size
    Sets flash location
    Sets `initial-state` in FV_URL if `fvInitialState` is not set
  fvInitialState=gates
    Optional, sets `initial-state` in FV_URL. If ommitted, `game` value is used
  missionID=3.2.3
    Sets `mission` in FV_URL
  numStars
    Sets `num-stars` in FV_URL
  nucleusGenes
    Sets &nucleus=true&relevant-gene-shorthand=[nucleusGenes]
  boss=true
    Sets `boss` in FV_URL
  preAlleles
    Sets `pre-alleles` in FV_URL
  preTargetColor
    Sets pre-target-color in FV_URL
  staging=true
    Whether to use FV Staging url
  video=charcoal&skip=true
    Sets zoom-in video to be shown and whether FF controls are visible

  NEW FV Protein Game URL Parameters:

  ?mission=3.2.1&allele-shorthand=11111111&initial-state=size&target-color=charcoal&num-stars=0
  ?mission=3.2.2&allele-shorthand=00111111&initial-state=size&target-color=charcoal
  ?mission=3.2.4&allele-shorthand=00111111&initial-state=size&target-color=charcoal&nucleus=true&relevant-gene-shorthand=11000000&boss=true

  Cell url:
    ?chal=lava-steel&alleles=00111111&game=nucleus&fvInitialState=gate&missionId=3.4.3&nucleusGenes=11000011&boss=true&preAlleles=11111111&preTargetColor=charcoal&numStars=13
  FV url:
    ?mission=3.4.3&allele-shorthand=00111111&initial-state=gate&target-color=steel&nucleus=true&relevant-gene-shorthand=11000011&boss=true&pre-alleles=11111111&pre-target-color=charcoal&num-stars=13
  -->

<html>
  <head>
    <script type="text/javascript" src="../../organelle.js" charset="utf-8"></script>
    <script type="text/javascript" src="lib/iframe-phone.js" charset="utf-8"></script>
    <style media="screen" type="text/css">
      body {
        background-color: black;
      }

      svg {
        background: center no-repeat url("assets/cell-background.png")
      }

      .model {
        position: absolute;
        left: 50%;
        top: 0;
        transform: translate(-50%, 0);
        height: 100vh;
        width: 160vh;
        opacity: 1;
        -webkit-transition: opacity 6s;
        transition: opacity 6s;
      }

      .hidden-iframe {
        width: 10;
        height: 10;
        opacity: 0;
      }

      .temp-iframe {
        opacity: 0;
      }

      iframe {
        position: absolute;
        width: 100%;
        height: 100%;
        border: none;
      }

      #world-props {
        position: absolute;
        right: 1vw;
        bottom: 1vh;
        display: none;
      }

      .clickable {
        cursor: pointer;
      }

      #black-overlay {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        background-color: black;
        -webkit-transition: opacity 1s;
        transition: opacity 1s;
        pointer-events: none;
      }

      #video-wrapper {
        position: absolute;
        left: 50%;
        top: 10vh;
        transform: translate(-50%, 0);
        height: 100vh;
        width: 151vh;
        padding-right: 7vh;
        pointer-events: none;
      }

      video {
        pointer-events: none;
      }

      #skip-button {
        pointer-events: all;
        display: none;
        position: absolute;
        left: 50%;
        transform: translate(-50%, 0);
        top: 86vh;
        margin-left: 58vh;
      }

      .button {
        display: inline-block;
        min-width: 23vh;
        font-family: sans-serif;
        -webkit-font-smoothing: antialiased;
        position: relative;
        padding: 2vh 4vh;
        padding-right: 13vh;
        background: #009ED8;
        border: none;
        color: white;
        transition: background .2s;
        font-size: 3vh;
        font-weight: bold;
        border-radius: 6px;
        overflow: hidden;
      }
      .button:before,
      .button:after {
        position: absolute;
        top: -2vh;
        bottom: 0;
        right: 0;
        padding-top: inherit;
        padding-bottom: inherit;
        width: 7vh;
        content: "\00a0";
        font-size: 6vh;
        text-align: center;
        transition: .2s;
        transform-origin: 50% 60%;
        transition: .2s;
        transform-origin: 50% 60%;
      }
      .button:before {
        background: rgba(0, 0, 0, 0.1);
      }
      .button:hover {
        background: #0079a5;
      }
      .button:active,
      .button:focus {
        background: #002e3f;
        outline: none;
      }
      .button:after {
        content: "\00bb";
      }
      .button:hover:after {
        -webkit-animation: bounceright .3s alternate ease infinite;
        animation: bounceright .3s alternate ease infinite;
      }

      @keyframes bounceright {
        from {
          transform: translateX(0);
        }
        to {
          transform: translateX(3px);
        }
      }

      @-webkit-keyframes bounceright {
        from {
          -webkit-transform: translateX(0);
        }
        to {
          -webkit-transform: translateX(3px);
        }
      }

    </style>
  </head>
  <body>
    <div id="black-overlay">
      <div id="video-wrapper">
          <video id="video" width="100%" muted playsinline>
            <source src="" type="video/mp4">
          </video>
      </div>
      <button class="button" id="skip-button">Skip</button>
    </div>
    <svg id="model" viewBox="0 50 1920 1080" class="model">
    </svg>
    <div id="protein-game-wrapper" class="model hidden-iframe">
      <iframe id="protein-game"></iframe>
    </div>

    <fieldset id="world-props">
      <legend>Cell props</legend>
      <input id="albino" type="checkbox" /><label for="albino">albino</label><br/>
      <input id="working_tyr1" type="checkbox" checked="checked"/><label for="working_tyr1">working_tyr1</label><br/>
      <input id="working_myosin_5a" type="checkbox" checked="checked"/><label for="working_tyr1">working_myosin_5a</label><br/>
      <input id="open_gates" type="checkbox" checked="checked"/><label for="open_gates">open_gates</label>
    </fieldset>

    <script>
      var model,
          initialDrakeColor = "ash",
          finalDrakeColor = "charcoal",
          alleles,
          numStars,
          gameType = "size", // "gate", "nucleus"
          missionId,
          isNucleusGame = false,
          boss=false,
          nucleusGenes,
          preAlleles,
          preTargetColor,
          challenge,
          fvInitialState,
          gameUrl = "https://www.fablevision.com/geniverse_proteins/index.html?allele-shorthand=10111111&initial-state=size&target-color=lava",
          parentPhone,
          phone,
          staging,
          videoName,
          skip,
          urlParams;

      (window.onpopstate = function () {
          var match,
              pl     = /\+/g,  // Regex for replacing addition symbol with a space
              search = /([^&=]+)=?([^&]*)/g,
              decode = function (s) { return decodeURIComponent(s.replace(pl, " ")) },
              query  = window.location.search.substring(1)

          urlParams = {}
          while (match = search.exec(query))
              urlParams[decode(match[1])] = decode(match[2])

          staging = urlParams.staging

          alleles = urlParams.alleles
          numStars = urlParams.numStars

          gameType = urlParams.game || "size"
          fvInitialState = urlParams.fvInitialState || gameType

          missionId = urlParams.missionId || null

          nucleusGenes = urlParams.nucleusGenes || null
          isNucleusGame = !!nucleusGenes
          boss = urlParams.boss || false
          preAlleles = urlParams.preAlleles || null
          preTargetColor = urlParams.preTargetColor || null

          challenge = urlParams.chal;
          skip = urlParams.skip || false;

          videoName = urlParams.video || null;
      })();

      if (videoName) {
        var video = document.getElementById('video');
        if (skip) {
          video.addEventListener('loadeddata', function() {
            document.getElementById('skip-button').style.display = 'block';
          }, false);
        }

        var videoSrc = "https://s3.amazonaws.com/models-resources/geniblocks/resources/fablevision/video/"+videoName+".mp4";
        document.querySelector("#video > source").src = videoSrc;
        video.load();

        if (video.readyState > 3) {
          video.play();
        } else {
          video.addEventListener('canplaythrough', function() {
            video.play();
          }, false);
        }

        var ffVideo = function() {
          video.playbackRate = 3.0;
        }

        var endVideo = function() {
          document.getElementById('black-overlay').style.opacity = 0;
          model.run();
          setTimeout(function() {
            document.getElementById('black-overlay').remove();
          }, 1000);
        }

        document.getElementById('skip-button').onclick = ffVideo;
        video.addEventListener('ended', endVideo, false);
      } else {
        document.getElementById('black-overlay').style.opacity = 0;
      }

      Organelle.createModel({
        element: "model",
        background: {
          file: "assets/melanocyte.svg",
          selector: "#cell"
        },
        properties: {
          albino: false,
          working_tyr1: true,
          working_myosin_5a: true,
          open_gates: true
        },
        species: [
          "organelles/melanosome.yml",
          "organelles/zoomed-melanosome.yml"
        ],
        clickHandlers: [
          {
            selector: "#golgi",
            action: enterSizeGame
          },
          {
            selector: "#clickable-gate",
            action: enterGatesGame
          },
          {
            selector: "#nucelus01",
            action: enterNucleusGame
          }
        ]
      }).then(function(m) {
        model = m;

        if (challenge) {
          initialDrakeColor = challenge.split("-")[0]
          finalDrakeColor = challenge.split("-")[1]
          setCellPhenotype(initialDrakeColor)
          setGameUrl(initialDrakeColor, finalDrakeColor)
        }

        model.stop();
        model.step(1000);
        if (!videoName) {
          model.run();
        }

        function glow(bool) {
          let els = Array.from(document.getElementsByClassName(gameType+"-glow")),
              style = bool ? "url(#glow)" : ""
          els.forEach( (el) => {
            el.style["filter"] = style
            // add style to change cursor to pointer when element is interactable
            if (el.className.baseVal.indexOf('clickable') === -1) el.className.baseVal += " clickable"
          } )

          model.setTimeout(() => glow(!bool),1000)
        }

        glow(true)
      });

      function addClass(el, className) {
        if (el.classList)
          el.classList.add(className);
        else
          el.className += ' ' + className;
      }

      function removeClass(el, className) {
        if (el.classList)
          el.classList.remove(className);
        else
          el.className = el.className.replace(new RegExp('(^|\\b)' + className.split(' ').join('|') + '(\\b|$)', 'gi'), ' ');
      }

      var iframe = document.getElementById("protein-game"),
          wrapper = document.getElementById("protein-game-wrapper"),
          entering = false,
          createdAgent,
          reverseZoom;

      function enterSizeGame(Snap, svg) {
        if (entering || gameType !== "size") {
          return
        }
        entering = true

        iframe.src = gameUrl

        let zoomDelay = 1300,
            iframeDelay = initialDrakeColor === "frost" ? 1800 : initialDrakeColor === "lava" ? 2300 : 2800,
            modelStopDelay = 4000
        Snap.animate(svg.attr("viewBox").vb.split(" "), [659, 741, 56, 35],
          function (vals) { svg.attr("viewBox", vals.join(" ")); }, zoomDelay
        );

        model.setTimeout( () => {
          createdAgent = model.world.createAgent(model.world.species[1])
        }, zoomDelay)
        model.setTimeout( () => {
          phone = new iframePhone.ParentEndpoint(iframe)
          phone.addListener('activityExit', function (content) {
            console.log("exit")
            setTimeout(exitProteinGame, 1000)
          })
          phone.addListener('activityWin', function (content) {
            console.log("win!")
            setTimeout(exitProteinGame, 1000)
            setCellPhenotype(finalDrakeColor)
            model.setTimeout( () => {console.log("win!!!", content); parentPhone.post('challengeWin', content)}, 4000)
          })
          phone.addListener('activityLoaded', function (content) {
            console.log("loaded!", content)
            // pass loading details up to parent once connection has been made - this
            // could include data on whether the activity includes a tutorial that can be toggled.
            setupPhoneConnections(content)
            // setTimeout(exitProteinGame, 1000)
            // setCellPhenotype(finalDrakeColor)
            // model.setTimeout( () => {console.log("win!!!"); parentPhone.post('challengeWin')}, 4000)
          })
          phone.addListener('stats', (stats) => {
            // Once user has won the challenge, these should be sent as part of activityWin
            // but we could call this manually if we wanted
            parentPhone.post('stats', stats)
          })

          removeClass(wrapper, "hidden-iframe")
        }, iframeDelay)
        model.setTimeout( () => {
          model.stop()
        }, modelStopDelay)

        reverseZoom = function() {
          Snap.animate(svg.attr("viewBox").vb.split(" "), [0, 15, 1920, 1080],
            function (vals) { svg.attr("viewBox", vals.join(" ")); }, 1500
          )
        }
      }

      function exitProteinGame() {
        addClass(wrapper, "temp-iframe");

        if (gameType === "size") {
          createdAgent.setProperty("size", 0.1)
          createdAgent.state = "growing"
        }
        model.step(2000)

        setTimeout(function() {
          iframe.src = ""
          reverseZoom()
          addClass(wrapper, "hidden-iframe")
          removeClass(wrapper, "temp-iframe")

          model.setTimeout(function() {
            if (gameType === "size") {
              createdAgent.species = model.world.species[0]
            }
            entering = false
          }, 600)
          model.run()
        }, 1000)
      }

      function enterGatesGame(Snap, svg, el) {
        if (entering || gameType !== "gate") {
          return
        }
        entering = true

        iframe.src = gameUrl

        let zoomDelay = 1300,
            iframeDelay = 1100,
            // iframeDelay = initialDrakeColor === "albino" ? 1800 : initialDrakeColor === "lava" ? 2300 : 2800,
            modelStopDelay = 2000
        let {x, y} = el.node.getBBox()
        Snap.animate(svg.attr("viewBox").vb.split(" "), [x-15, y-5, 240, 150],
          function (vals) { svg.attr("viewBox", vals.join(" ")); }, zoomDelay
        );

        // model.setTimeout( () => {
        //   createdAgent = model.world.createAgent(model.world.species[1])
        // }, zoomDelay)
        model.setTimeout( () => {
          phone = new iframePhone.ParentEndpoint(iframe)
          phone.addListener('activityExit', function (content) {
            setTimeout(exitProteinGame, 1000)
          })
          phone.addListener('activityWin', function (content) {
            setTimeout(exitProteinGame, 1000)
            console.log("win!")
            setCellPhenotype(finalDrakeColor)
            model.setTimeout( () => {console.log("win!!!"); parentPhone.post('challengeWin')}, 4000)
          })

          removeClass(wrapper, "hidden-iframe")
        }, iframeDelay)
        model.setTimeout( () => {
          model.stop()
        }, modelStopDelay)

        reverseZoom = function() {
          Snap.animate(svg.attr("viewBox").vb.split(" "), [0, 15, 1920, 1080],
            function (vals) { svg.attr("viewBox", vals.join(" ")); }, 1500
          )
        }
      }

      function enterNucleusGame(Snap, svg, el) {
        if (entering || gameType !== "nucleus") {
          return
        }
        entering = true

        iframe.src = gameUrl

        let zoomDelay = 1300,
            iframeDelay = 1100,
            // iframeDelay = initialDrakeColor === "albino" ? 1800 : initialDrakeColor === "lava" ? 2300 : 2800,
            modelStopDelay = 2000
        let {x, y} = el.node.getBBox()
        Snap.animate(svg.attr("viewBox").vb.split(" "), [x+40, y+15, 72, 45],
          function (vals) { svg.attr("viewBox", vals.join(" ")); }, zoomDelay
        );

        // model.setTimeout( () => {
        //   createdAgent = model.world.createAgent(model.world.species[1])
        // }, zoomDelay)
        model.setTimeout( () => {
          phone = new iframePhone.ParentEndpoint(iframe)
          phone.addListener('activityExit', function (content) {
            setCellPhenotype(content.resultingGeneticColor)
            setGameUrl(content.resultingGeneticColor, finalDrakeColor, true)
            setTimeout(exitProteinGame, 500)
            if (content.resultingGeneticColor === finalDrakeColor) {
              model.setTimeout( () => {console.log("win!!!"); parentPhone.post('challengeWin')}, 4000)
            }
          })

          phone.addListener('activityWin', function (content) {
            setCellPhenotype(content.resultingGeneticColor)
            setGameUrl(content.resultingGeneticColor, finalDrakeColor, true)
            setTimeout(exitProteinGame, 500)
            if (content.resultingGeneticColor === finalDrakeColor) {
              model.setTimeout( () => {console.log("win!!!"); parentPhone.post('challengeWin')}, 4000)
            } else {
              model.setTimeout( () => {console.log("fail!"); parentPhone.post('challengeFail')}, 4000)
            }
          })

          removeClass(wrapper, "hidden-iframe")
        }, iframeDelay)
        model.setTimeout( () => {
          model.stop()
        }, modelStopDelay)

        reverseZoom = function() {
          Snap.animate(svg.attr("viewBox").vb.split(" "), [0, 15, 1920, 1080],
            function (vals) { svg.attr("viewBox", vals.join(" ")); }, 1500
          )
        }
      }

      function setGatesProp(open) {
        // FIXME, need rendered callback
        if (document.getElementById("gate_A") === null) {
          setTimeout( () => { setGatesProp(open) }, 500)
        } else {
          let type = open ? "_open" : "_closed"
          for (let id of ["gate_A", "gate_B", "gate_C", "gate_D"]) {
            document.getElementById(id).setAttribute("xlink:href", "#"+id+type)
          }
        }
      }

      function observePropCheckbox(prop, callback) {
        document.getElementById(prop).onclick = function() {
          let val = document.getElementById(prop).checked
          model.world.setProperty(prop, val)
          setCellColor
          if (callback) {
            callback(val)
          }
        }
      }
      function setPropCheckbox(prop, value) {
        model.world.setProperty(prop, value)
        document.getElementById(prop).checked = value
        if (prop === "open_gates") setGatesProp(value)
      }
      observePropCheckbox("albino")
      observePropCheckbox("working_tyr1")
      observePropCheckbox("working_myosin_5a")
      observePropCheckbox("open_gates", setGatesProp)

      function setCellPhenotype(color) {
        let colorProps = {
                  // albino tyr1   myo5   gates
          frost:    [true,  false, false, false],
          charcoal: [false, true,  true,  true],
          steel:    [false, true,  true,  false],
          ash:      [false, true,  false, true],
          silver:   [false, true,  false, false],
          lava:     [false, false, true,  true],
          copper:   [false, false, true,  false],
          sand:     [false, false, false, true],
          gold:     [false, false, false, false],
        }

        setPropCheckbox("albino", colorProps[color][0])
        setPropCheckbox("working_tyr1", colorProps[color][1])
        setPropCheckbox("working_myosin_5a", colorProps[color][2])
        setPropCheckbox("open_gates", colorProps[color][3])

        setCellColor(color);
      }

      function setCellColor(color) {
        if (!document.getElementById("Layer0_0_FILL")) {
          setTimeout(function() {setCellColor(color)}, 20);
          return;
        }
        let colorValues = {
          frost:    {cell: '#B4B5B2', border: '#C4C6C1', outer: false},
          charcoal: {cell: '#58605C', border: '#878C86', outer: true},
          steel:    {cell: '#58605C', border: '#878C86', outer: false},
          ash:      {cell: '#FD4D11', border: '#D1AA90', outer: true},
          silver:   {cell: '#FD4D11', border: '#D1AA90', outer: false},
          lava:     {cell: '#FD4D11', border: '#D1AA90', outer: true},
          copper:   {cell: '#FD4D11', border: '#D1AA90', outer: false},
          sand:     {cell: '#FD4D11', border: '#D1AA90', outer: true},
          gold:     {cell: '#FD4D11', border: '#D1AA90', outer: false}
        }

        const colorValue = colorValues[color];

        document.getElementById("Layer0_0_FILL").style["fill"] = colorValue.cell;
        document.getElementById("Layer0_0_1_STROKES").style['stroke'] = colorValue.border;
        if (colorValue.outer) {
          document.querySelector("#Layer0_0_FILL_1_ path").style["fill"] = colorValue.cell;
          document.getElementById("shine").style["visibility"] = "hidden";
        } else {
          document.querySelector("#Layer0_0_FILL_1_ path").style["fill"] = 'url("#_Radial1")';
          document.getElementById("shine").style["visibility"] = "visible"
        }
      }

      function setGameUrl(initial, final, forceNewShorthand) {
        let alleleShorthand, stars

        let missionQuery = missionId ? "mission=" + missionId + "&" : ""
        let bossQuery = boss ? "boss=true&" : ""
        let preAllelesQuery = preAlleles ? "pre-alleles=" + preAlleles + "&" : ""
        let preTargetColorQuery = preTargetColor ? "pre-target-color=" + preTargetColor + "&" : ""

        if (alleles && !forceNewShorthand) {
          alleleShorthand = alleles
        } else {
          let alleleShorthands = {
                    // t a m g?
            frost:    "11001111",
            charcoal: "10111111",
            steel:    "10111100",
            lava:     "00111111",
            copper:   "00111110",
            sand:     "00110011"
          }
          alleleShorthand = alleleShorthands[initial]
        }
        stars = numStars ? "&num-stars="+numStars : ""

        let nucleusString = ""
        if (isNucleusGame) {
          nucleusString = "&nucleus=true&relevant-gene-shorthand="+nucleusGenes
        }

        let fvStaging = "//geniventure.concord.org/branch/staging/resources/proteingame/index.html?"
        let fvLive = "//geniventure.concord.org/resources/proteingame/index.html?"
        let fvDev = "http://geniverse2.fablevision-dev.com/protein_game_2/index.html?"
        // fvDev only used locally for testing, won't work with portal since it does not support https
        let urlBase = staging ? fvStaging : fvLive

        gameUrl = urlBase+missionQuery+bossQuery+preAllelesQuery+preTargetColorQuery+"allele-shorthand="+alleleShorthand+"&initial-state="+fvInitialState+"&target-color="+final+stars+nucleusString
      }
      parentPhone = iframePhone.getIFrameEndpoint()
      parentPhone.initialize()

      function setupPhoneConnections(data){
        parentPhone.addListener('togglePopups', function(){
          if (phone){
            phone.post('showTutorial');
          }
        })

        parentPhone.addListener('getStats', function(){
          if (phone){
            phone.post('getActionStats');
          }
        })

        parentPhone.addListener('showStats', function(){
          if (phone){
            phone.post('showActionStats');
          }
        })

        parentPhone.addListener('hideStats', function(){
          if (phone){
            phone.post('hideActionStats');
          }
        })
        // once listeners are set up, send message to parent with details of whether activity has
        // tutorials (or any other data we choose to support later)
        parentPhone.post('activityLoaded', data)
      }
    </script>
  </body>
</html>
